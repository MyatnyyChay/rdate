--- rdate-1.3/rdate.c.orig	Wed Nov  6 16:58:53 2002
+++ rdate-1.3/rdate.c	Sat Apr  5 00:31:29 2003
@@ -69,8 +69,14 @@
 static int
 rdate(const char *hostname, time_t *retval)
 {
+#ifndef INET6
   struct servent *sent;
   struct sockaddr_in saddr;
+#else
+  char host[NI_MAXHOST];
+  struct addrinfo hints, *res, *res0;
+  int err = -1;
+#endif
   int fd;
   unsigned char time_buf[4];
   int nr, n_toread;
@@ -78,6 +84,7 @@
   assert(hostname);
   assert(retval);
 
+#ifndef INET6
   saddr.sin_family = AF_INET;
 
   if(!inet_aton(hostname, &saddr.sin_addr))
@@ -111,8 +118,37 @@
       return -1;
     }
 
+#else
+  snprintf(host, sizeof(host), "%s", hostname);
+  memset(&hints, 0, sizeof(hints));
+  hints.ai_family = AF_UNSPEC;
+  hints.ai_socktype = (use_tcp) ? SOCK_STREAM : SOCK_DGRAM;
+  err = getaddrinfo(host, "time", &hints, &res0);
+  if (err < 0) {
+	  writeLog(1, "%s: %s", host, gai_strerror(err));
+	  return -1;
+  }
+  err = -1;
+
+  for (res = res0; res; res = res->ai_next) {
+	  if ((fd = socket(res->ai_family, res->ai_socktype, res->ai_protocol)) >= 0) {
+		  err = 0;
+		  break;
+	  }
+  }
+  freeaddrinfo(res0);
+  if (err < 0) {
+	  writeLog(1, "couldn't create socket: %s", strerror(errno));
+	  return -1;
+  }
+#endif
+
   if (use_tcp) {
+#ifndef INET6
     if(connect(fd, &saddr, sizeof(saddr)))
+#else
+    if (connect(fd, res->ai_addr, res->ai_addrlen))
+#endif
       {
         writeLog(1, "couldn't connect to host %s: %s", hostname, strerror(errno));
         close(fd);
@@ -132,13 +168,21 @@
         return -1;
       }
   } else {
+#ifndef INET6
     if (sendto(fd, NULL, 0, 0, &saddr, sizeof(saddr))) {
+#else
+    if (sendto(fd, NULL, 0, 0, res->ai_addr, res->ai_addrlen)) {
+#endif
       writeLog(1, "couldn't send UDP message to host %s: %s", hostname, strerror(errno));
       close(fd);
       return -1;
     }
 
+#ifndef INET6
     if (recvfrom(fd, &time_buf, sizeof(time_buf), 0, &saddr, &nr) != 4)
+#else
+    if (recvfrom(fd, &time_buf, sizeof(time_buf), 0, res->ai_addr, &res->ai_addrlen) != 4)
+#endif
     {
       if(nr)
 	writeLog(1, "error in read: %s", strerror(errno));
